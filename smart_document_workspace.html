<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Document Workspace</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="icon" href="favicon.png" type="image/png" />
    <style>
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .file-item {
            transition: all 0.2s ease;
        }
        .file-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .room-item {
            transition: all 0.2s ease;
        }
        .room-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .room-item.active {
            background-color: #e0f2fe !important;
            border-color: #0288d1 !important;
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.2) !important;
        }
        #chat-messages {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .notification.info {
            background-color: #3b82f6;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .processing-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 2000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .settings-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            cursor: pointer;
            color: #6b7280;
            font-size: 1.5rem;
            transition: all 0.2s ease;
        }
        .settings-icon:hover {
            color: #3b82f6;
            transform: rotate(90deg);
        }
        .model-tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #e0f2fe;
            color: #0288d1;
            margin-left: 8px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!--
    ================================================================================
    SMART DOCUMENT WORKSPACE
    ================================================================================
    Author: Tomio Kobayashi
    Version: 1.0.3
    Created: 2025/07/12

    Description:
    A revolutionary client-side RAG (Retrieval-Augmented Generation) application 
    that enables users to upload documents, organize them into rooms, and chat 
    with AI using document context entirely within the browser.

    Key Features:
    - Client-side document processing and vector embeddings
    - Multi-room organization with independent contexts
    - LLM model selection per room
    - IndexedDB storage for offline capability
    - No server-side processing required
    - Privacy-focused local execution

    Technical Stack:
    - Vanilla JavaScript with ES6 modules
    - Xenova/Transformers.js for embeddings
    - IndexedDB for local storage
    - OpenAI API integration
    - TailwindCSS for styling

    Copyright Notice:
    This software contains proprietary algorithms and implementations for 
    client-side RAG functionality. All rights reserved.
    ================================================================================
    -->

    <!-- Settings Icon -->
    <i class="fas fa-cog settings-icon" id="settings-icon" title="Settings"></i>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Settings</h3>
                <button id="close-settings" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- API Key Section -->
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">OpenAI API Key</label>
                <input type="password" id="settings-api-key" placeholder="sk-..."
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <p class="text-sm text-gray-500 mt-1">Your API key is stored locally and never sent to our servers</p>
            </div>

            <!-- Available Models Section -->
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">Available Models</label>
                <div id="model-list" class="space-y-2 mb-3">
                    <!-- Dynamic model list will be populated here -->
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-model-input" placeholder="e.g., gpt-4-turbo"
                           class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button id="add-model-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button id="save-settings-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Settings
                </button>
                <button id="reset-settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-undo mr-2"></i>Reset
                </button>
            </div>
        </div>
    </div>

    <div class="processing-indicator" id="processing-indicator">
        <div class="spinner"></div>
        <div id="processing-text">Initializing AI models...</div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            <i class="fas fa-brain text-blue-500 mr-2"></i>
            Smart Document Workspace
        </h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
            <!-- Room Management Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <!-- Room Creation -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-plus-circle text-green-500 mr-2"></i>
                            Create Room
                        </h3>
                        <div class="mb-2">
                            <input type="text" id="new-room-name" placeholder="Room name..."
                                   class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div class="mb-2">
                            <select id="room-model-select" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Model...</option>
                            </select>
                        </div>
                        <button id="create-room-btn"
                                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                            <i class="fas fa-plus mr-2"></i>Create Room
                        </button>
                    </div>

                    <!-- Room List -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-door-open text-blue-500 mr-2"></i>
                            Chat Rooms
                        </h3>
                        <div id="room-list" class="space-y-2">
                            <div class="text-center text-gray-500 italic">
                                No rooms created yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-6 h-full">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-upload text-green-500 mr-2"></i>
                        Upload Documents
                    </h2>
                    
                    <div id="upload-section" class="hidden">
                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                <span class="text-blue-700 font-medium">Active Room:</span>
                            </div>
                            <div id="active-room-info" class="text-blue-600 font-semibold mt-1"></div>
                        </div>

                        <form id="upload-form" enctype="multipart/form-data" class="mb-4">
                            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors duration-200 cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600 mb-2">Drag & drop files here or click to select</p>
                                <input type="file" name="files" id="file-input" multiple accept=".txt,.pdf,.doc,.docx,.md" class="hidden" />
                                <button type="button" id="select-files" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                                    <i class="fas fa-folder-open mr-2"></i>Select Files
                                </button>
                            </div>
                            
                            <div id="selected-files" class="mt-4 space-y-2"></div>
                            
                            <button type="submit" id="upload-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 mt-4 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <i class="fas fa-upload mr-2"></i>Process Documents
                            </button>
                        </form>

                        <!-- Document List -->
                        <div id="document-list" class="mt-4">
                            <h4 class="font-medium text-gray-700 mb-2">Processed Documents</h4>
                            <div id="document-items" class="space-y-1">
                                <div class="text-sm text-gray-500 italic">No documents processed</div>
                            </div>
                        </div>
                    </div>

                    <div id="no-room-message" class="text-center text-gray-500 italic">
                        <i class="fas fa-info-circle mr-2"></i>
                        Select a room to upload documents
                    </div>
                </div>
            </div>
            
            <!-- Chat Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-comments text-blue-500 mr-2"></i>
                            Chat Interface
                        </h2>
                        <button id="clear-history-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200 hidden">
                            <i class="fas fa-trash mr-1"></i>Clear History
                        </button>
                    </div>
                    
                    <div id="chat-messages" class="flex-1 bg-gray-50 rounded-lg p-4 mb-4 overflow-y-auto">
                        <div id="no-chat-message" class="text-center text-gray-500 italic">
                            <i class="fas fa-info-circle mr-2"></i>
                            Select a room and upload documents to start chatting...
                        </div>
                    </div>
                    
                    <form id="chat-form" class="flex gap-2">
                        <div class="flex-1 relative">
                            <input type="text" id="question" placeholder="Ask a question about your documents..." 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                   required disabled />
                            <div class="absolute right-2 top-2 text-gray-400 text-sm">
                                Press Enter to send
                            </div>
                        </div>
                        <button type="submit" id="send-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Client-side RAG Chat Application
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0/dist/transformers.min.js';

        // Configure transformers
        env.allowRemoteModels = true;
        env.allowLocalModels = false;

        class ClientStorage {
            constructor() {
                this.dbName = 'SmartDocumentWorkspaceDB';
                this.version = 1;
                this.db = null;
            }

            async clearDatabase() {
                // Close existing connection
                if (this.db) {
                    this.db.close();
                    this.db = null;
                }

                // Delete the database completely
                return new Promise((resolve, reject) => {
                    const deleteRequest = indexedDB.deleteDatabase(this.dbName);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => reject(deleteRequest.error);
                    deleteRequest.onblocked = () => {
                        console.warn('Database deletion blocked');
                        resolve(); // Continue anyway
                    };
                });
            }

            async initialize() {
                // Always start with a clean database
                await this.clearDatabase();
                
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('rooms')) {
                            const roomStore = db.createObjectStore('rooms', { keyPath: 'id' });
                            roomStore.createIndex('name', 'name', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('documents')) {
                            const docStore = db.createObjectStore('documents', { keyPath: 'id' });
                            docStore.createIndex('roomId', 'roomId', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('vectors')) {
                            const vectorStore = db.createObjectStore('vectors', { keyPath: 'id' });
                            vectorStore.createIndex('roomId', 'roomId', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('chatHistory')) {
                            const chatStore = db.createObjectStore('chatHistory', { keyPath: 'id' });
                            chatStore.createIndex('roomId', 'roomId', { unique: false });
                        }
                    };
                });
            }

            async saveRoom(room) {
                const transaction = this.db.transaction(['rooms'], 'readwrite');
                const store = transaction.objectStore('rooms');
                return store.put(room);
            }

            async getRooms() {
                const transaction = this.db.transaction(['rooms'], 'readonly');
                const store = transaction.objectStore('rooms');
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async saveDocuments(roomId, documents) {
                const transaction = this.db.transaction(['documents'], 'readwrite');
                const store = transaction.objectStore('documents');
                
                for (const doc of documents) {
                    await store.put({
                        id: `${roomId}_${Date.now()}_${Math.random()}`,
                        roomId: roomId,
                        ...doc
                    });
                }
            }

            async getDocuments(roomId) {
                const transaction = this.db.transaction(['documents'], 'readonly');
                const store = transaction.objectStore('documents');
                const index = store.index('roomId');
                
                return new Promise((resolve, reject) => {
                    const request = index.getAll(roomId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async saveVectors(roomId, vectors) {
                const transaction = this.db.transaction(['vectors'], 'readwrite');
                const store = transaction.objectStore('vectors');
                
                return store.put({
                    id: roomId,
                    roomId: roomId,
                    vectors: vectors,
                    timestamp: Date.now()
                });
            }

            async getVectors(roomId) {
                const transaction = this.db.transaction(['vectors'], 'readonly');
                const store = transaction.objectStore('vectors');
                
                return new Promise((resolve, reject) => {
                    const request = store.get(roomId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async saveChatHistory(roomId, message) {
                const transaction = this.db.transaction(['chatHistory'], 'readwrite');
                const store = transaction.objectStore('chatHistory');
                
                return store.put({
                    id: `${roomId}_${Date.now()}_${Math.random()}`,
                    roomId: roomId,
                    ...message
                });
            }

            async getChatHistory(roomId) {
                const transaction = this.db.transaction(['chatHistory'], 'readonly');
                const store = transaction.objectStore('chatHistory');
                const index = store.index('roomId');
                
                return new Promise((resolve, reject) => {
                    const request = index.getAll(roomId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async clearChatHistory(roomId) {
                const transaction = this.db.transaction(['chatHistory'], 'readwrite');
                const store = transaction.objectStore('chatHistory');
                const index = store.index('roomId');
                
                return new Promise((resolve, reject) => {
                    const request = index.openCursor(roomId);
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            cursor.delete();
                            cursor.continue();
                        } else {
                            resolve();
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteRoom(roomId) {
                const transaction = this.db.transaction(['rooms', 'documents', 'vectors', 'chatHistory'], 'readwrite');
                
                // Delete room
                await transaction.objectStore('rooms').delete(roomId);
                
                // Delete associated data
                const stores = ['documents', 'vectors', 'chatHistory'];
                for (const storeName of stores) {
                    const store = transaction.objectStore(storeName);
                    if (storeName === 'vectors') {
                        await store.delete(roomId);
                    } else {
                        const index = store.index('roomId');
                        const request = index.openCursor(roomId);
                        request.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                cursor.delete();
                                cursor.continue();
                            }
                        };
                    }
                }
            }
        }

        class VectorSearchEngine {
            constructor() {
                this.embedder = null;
                this.vectors = [];
                this.documents = [];
                this.initialized = false;
            }

            async initialize() {
                if (this.initialized) return;
                
                try {
                    this.embedder = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
                    this.initialized = true;
                } catch (error) {
                    console.error('Failed to initialize embedder:', error);
                    throw error;
                }
            }

            async createEmbeddings(texts) {
                if (!this.initialized) await this.initialize();
                
                const embeddings = [];
                for (const text of texts) {
                    const embedding = await this.embedder(text, { pooling: 'mean', normalize: true });
                    embeddings.push(Array.from(embedding.data));
                }
                
                return embeddings;
            }

            async addDocuments(documents) {
                const embeddings = await this.createEmbeddings(documents.map(doc => doc.text));
                
                this.vectors = documents.map((doc, index) => ({
                    id: index,
                    embedding: embeddings[index],
                    document: doc,
                    timestamp: Date.now()
                }));
                
                this.documents = documents;
            }

            async search(query, topK = 5) {
                if (!this.initialized) await this.initialize();
                
                const queryEmbedding = await this.embedder(query, { pooling: 'mean', normalize: true });
                const queryVector = Array.from(queryEmbedding.data);
                
                const similarities = this.vectors.map(item => ({
                    ...item,
                    similarity: this.cosineSimilarity(queryVector, item.embedding)
                }));
                
                return similarities
                    .sort((a, b) => b.similarity - a.similarity)
                    .slice(0, topK);
            }

            cosineSimilarity(vecA, vecB) {
                const dotProduct = vecA.reduce((sum, a, i) => sum + a * vecB[i], 0);
                const magnitudeA = Math.sqrt(vecA.reduce((sum, a) => sum + a * a, 0));
                const magnitudeB = Math.sqrt(vecB.reduce((sum, b) => sum + b * b, 0));
                return dotProduct / (magnitudeA * magnitudeB);
            }

            clearVectors() {
                this.vectors = [];
                this.documents = [];
            }

            loadVectors(vectorData) {
                this.clearVectors();
                if (vectorData && vectorData.vectors) {
                    this.vectors = vectorData.vectors || [];
                    this.documents = this.vectors.map(v => v.document);
                }
            }
        }

        class SmartDocumentWorkspace {
            constructor() {
                this.storage = new ClientStorage();
                this.vectorEngine = new VectorSearchEngine();
                this.currentRoom = null;
                this.rooms = new Map();
                this.openaiApiKey = localStorage.getItem('openai_api_key') || '';
                this.availableModels = this.loadAvailableModels();
                
                this.initializeApp();
            }

            loadAvailableModels() {
                const saved = localStorage.getItem('available_models');
                if (saved) {
                    return JSON.parse(saved);
                }
                return ['gpt-3.5-turbo', 'gpt-4'];
            }

            saveAvailableModels() {
                localStorage.setItem('available_models', JSON.stringify(this.availableModels));
            }

            async initializeApp() {
                this.showProcessingIndicator('Initializing application...');
                
                try {
                    await this.storage.initialize();
                    this.setupEventListeners();
                    await this.loadRooms();
                    this.updateModelSelects();
                    this.updateSettingsModal();
                    
                    this.hideProcessingIndicator();
                    this.showNotification('Application initialized successfully!', 'success');
                } catch (error) {
                    this.hideProcessingIndicator();
                    this.showNotification('Failed to initialize application: ' + error.message, 'error');
                }
            }

            setupEventListeners() {
                // Settings modal
                document.getElementById('settings-icon').addEventListener('click', () => {
                    this.showSettingsModal();
                });

                document.getElementById('close-settings').addEventListener('click', () => {
                    this.hideSettingsModal();
                });

                document.getElementById('save-settings-btn').addEventListener('click', () => {
                    this.saveSettings();
                });

                document.getElementById('reset-settings-btn').addEventListener('click', () => {
                    this.resetSettings();
                });

                document.getElementById('add-model-btn').addEventListener('click', () => {
                    this.addModel();
                });

                document.getElementById('new-model-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addModel();
                });

                // Room management
                document.getElementById('create-room-btn').addEventListener('click', () => {
                    this.createRoom();
                });

                document.getElementById('new-room-name').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createRoom();
                });

                // File upload
                document.getElementById('select-files').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });

                document.getElementById('file-input').addEventListener('change', () => {
                    this.displaySelectedFiles();
                });

                document.getElementById('upload-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.processDocuments();
                });

                // Chat
                document.getElementById('chat-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                document.getElementById('question').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                document.getElementById('clear-history-btn').addEventListener('click', () => {
                    this.clearChatHistory();
                });

                // Drag and drop
                const dropZone = document.getElementById('drop-zone');
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('drag-active');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('drag-active');
                    }, false);
                });

                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    document.getElementById('file-input').files = files;
                    this.displaySelectedFiles();
                }, false);

                // Modal click outside to close
                document.getElementById('settings-modal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.hideSettingsModal();
                    }
                });
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            showSettingsModal() {
                document.getElementById('settings-modal').classList.add('show');
                document.getElementById('settings-api-key').value = this.openaiApiKey;
                this.updateModelList();
            }

            hideSettingsModal() {
                document.getElementById('settings-modal').classList.remove('show');
            }

            updateSettingsModal() {
                document.getElementById('settings-api-key').value = this.openaiApiKey;
                this.updateModelList();
            }

            updateModelList() {
                const modelList = document.getElementById('model-list');
                modelList.innerHTML = this.availableModels.map(model => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <span class="text-gray-700">${model}</span>
                        <button class="text-red-500 hover:text-red-700" onclick="app.removeModel('${model}')">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `).join('');
            }

            addModel() {
                const input = document.getElementById('new-model-input');
                const modelName = input.value.trim();
                
                if (!modelName) {
                    this.showNotification('Please enter a model name.', 'error');
                    return;
                }
                
                if (this.availableModels.includes(modelName)) {
                    this.showNotification('Model already exists.', 'error');
                    return;
                }
                
                this.availableModels.push(modelName);
                input.value = '';
                this.updateModelList();
                this.updateModelSelects();
                this.showNotification(`Model "${modelName}" added successfully!`, 'success');
            }

            removeModel(modelName) {
                this.availableModels = this.availableModels.filter(m => m !== modelName);
                this.updateModelList();
                this.updateModelSelects();
                this.showNotification(`Model "${modelName}" removed successfully!`, 'success');
            }

            updateModelSelects() {
                const roomModelSelect = document.getElementById('room-model-select');
                roomModelSelect.innerHTML = '<option value="">Select Model...</option>' + 
                    this.availableModels.map(model => `<option value="${model}">${model}</option>`).join('');
            }

            saveSettings() {
                const apiKey = document.getElementById('settings-api-key').value.trim();
                
                if (apiKey) {
                    this.openaiApiKey = apiKey;
                    localStorage.setItem('openai_api_key', apiKey);
                }
                
                this.saveAvailableModels();
                this.hideSettingsModal();
                this.showNotification('Settings saved successfully!', 'success');
            }

            resetSettings() {
                if (!confirm('Are you sure you want to reset all settings?')) return;
                
                localStorage.removeItem('openai_api_key');
                localStorage.removeItem('available_models');
                
                this.openaiApiKey = '';
                this.availableModels = ['gpt-3.5-turbo', 'gpt-4'];
                
                this.updateSettingsModal();
                this.updateModelSelects();
                this.showNotification('Settings reset successfully!', 'success');
            }

            async createRoom() {
                const roomName = document.getElementById('new-room-name').value.trim();
                const selectedModel = document.getElementById('room-model-select').value;
                
                if (!roomName) {
                    this.showNotification('Please enter a room name.', 'error');
                    return;
                }
                
                if (!selectedModel) {
                    this.showNotification('Please select a model.', 'error');
                    return;
                }

                const room = {
                    id: Date.now().toString(),
                    name: roomName,
                    model: selectedModel,
                    created_at: new Date().toISOString(),
                    document_count: 0,
                    chat_count: 0
                };

                try {
                    await this.storage.saveRoom(room);
                    this.rooms.set(room.id, room);
                    document.getElementById('new-room-name').value = '';
                    document.getElementById('room-model-select').value = '';
                    this.updateRoomList();
                    this.showNotification(`Room "${roomName}" created successfully!`, 'success');
                } catch (error) {
                    this.showNotification('Failed to create room: ' + error.message, 'error');
                }
            }

            async loadRooms() {
                try {
                    const rooms = await this.storage.getRooms();
                    this.rooms.clear();
                    rooms.forEach(room => {
                        this.rooms.set(room.id, room);
                    });
                    this.updateRoomList();
                } catch (error) {
                    console.error('Failed to load rooms:', error);
                }
            }

            updateRoomList() {
                const roomList = document.getElementById('room-list');
                
                if (this.rooms.size === 0) {
                    roomList.innerHTML = '<div class="text-center text-gray-500 italic">No rooms created yet</div>';
                    return;
                }

                roomList.innerHTML = Array.from(this.rooms.values()).map(room => `
                    <div class="room-item bg-white border border-gray-200 rounded-lg p-3 cursor-pointer ${this.currentRoom && this.currentRoom.id === room.id ? 'active' : ''}" 
                         onclick="app.selectRoom('${room.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-700">
                                    ${room.name}
                                    <span class="model-tag">${room.model}</span>
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${room.document_count} docs • ${room.chat_count} messages
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="text-red-500 hover:text-red-700 transition-colors duration-200" 
                                        onclick="event.stopPropagation(); app.deleteRoom('${room.id}', '${room.name}')">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async selectRoom(roomId) {
                // Save current room vectors before switching
                if (this.currentRoom && this.vectorEngine.vectors.length > 0) {
                    await this.saveCurrentRoomVectors();
                }
                
                // Set new current room
                this.currentRoom = this.rooms.get(roomId);
                
                // Update UI immediately
                this.updateRoomList(); // This will update the active class
                
                // Update UI sections
                document.getElementById('upload-section').classList.remove('hidden');
                document.getElementById('no-room-message').classList.add('hidden');
                document.getElementById('active-room-info').textContent = this.currentRoom.name;
                document.getElementById('no-chat-message').classList.add('hidden');
                document.getElementById('clear-history-btn').classList.remove('hidden');
                
                // Enable chat if we have documents
                if (this.currentRoom.document_count > 0) {
                    document.getElementById('question').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                }
                
                // Load room data
                await this.loadRoomDocuments(roomId);
                await this.loadRoomVectors(roomId);
                await this.loadRoomChatHistory(roomId);
            }

            async saveCurrentRoomVectors() {
                if (this.currentRoom && this.vectorEngine.vectors.length > 0) {
                    try {
                        await this.storage.saveVectors(this.currentRoom.id, {
                            vectors: this.vectorEngine.vectors,
                            timestamp: Date.now()
                        });
                    } catch (error) {
                        console.error('Failed to save room vectors:', error);
                    }
                }
            }

            async deleteRoom(roomId, roomName) {
                if (!confirm(`Are you sure you want to delete room "${roomName}"? This action cannot be undone.`)) {
                    return;
                }

                try {
                    await this.storage.deleteRoom(roomId);
                    this.rooms.delete(roomId);
                    
                    if (this.currentRoom && this.currentRoom.id === roomId) {
                        this.currentRoom = null;
                        document.getElementById('upload-section').classList.add('hidden');
                        document.getElementById('no-room-message').classList.remove('hidden');
                        document.getElementById('clear-history-btn').classList.add('hidden');
                        document.getElementById('question').disabled = true;
                        document.getElementById('send-btn').disabled = true;
                        this.clearChatMessages();
                    }
                    
                    this.updateRoomList();
                    this.showNotification(`Room "${roomName}" deleted successfully!`, 'success');
                } catch (error) {
                    this.showNotification('Failed to delete room: ' + error.message, 'error');
                }
            }

            displaySelectedFiles() {
                const fileInput = document.getElementById('file-input');
                const files = Array.from(fileInput.files);
                const selectedFilesDiv = document.getElementById('selected-files');
                const uploadBtn = document.getElementById('upload-btn');
                
                selectedFilesDiv.innerHTML = '';
                uploadBtn.disabled = files.length === 0;

                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between';
                    fileItem.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-file text-blue-500 mr-2"></i>
                            <div>
                                <div class="font-medium text-gray-700">${file.name}</div>
                                <div class="text-sm text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                            </div>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 transition-colors duration-200" onclick="app.removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedFilesDiv.appendChild(fileItem);
                });
            }

            removeFile(index) {
                const fileInput = document.getElementById('file-input');
                const dt = new DataTransfer();
                const files = Array.from(fileInput.files);
                
                files.forEach((file, i) => {
                    if (i !== index) {
                        dt.items.add(file);
                    }
                });
                
                fileInput.files = dt.files;
                this.displaySelectedFiles();
            }

            async processDocuments() {
                if (!this.currentRoom) {
                    this.showNotification('Please select a room first.', 'error');
                    return;
                }

                const fileInput = document.getElementById('file-input');
                const files = Array.from(fileInput.files);
                
                if (files.length === 0) {
                    this.showNotification('Please select files to process.', 'error');
                    return;
                }

                const uploadBtn = document.getElementById('upload-btn');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                this.showProcessingIndicator('Processing documents...');

                try {
                    const documents = await this.readFiles(files);
                    
                    this.showProcessingIndicator('Creating embeddings...');
                    await this.vectorEngine.addDocuments(documents);
                    
                    this.showProcessingIndicator('Saving to storage...');
                    await this.storage.saveDocuments(this.currentRoom.id, documents);
                    await this.storage.saveVectors(this.currentRoom.id, {
                        vectors: this.vectorEngine.vectors,
                        timestamp: Date.now()
                    });

                    // Update room document count
                    this.currentRoom.document_count = documents.length;
                    await this.storage.saveRoom(this.currentRoom);
                    
                    fileInput.value = '';
                    this.displaySelectedFiles();
                    await this.loadRoomDocuments(this.currentRoom.id);
                    this.updateRoomList();
                    
                    // Enable chat
                    document.getElementById('question').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                    
                    this.hideProcessingIndicator();
                    this.showNotification(`Processed ${documents.length} documents successfully!`, 'success');
                } catch (error) {
                    this.hideProcessingIndicator();
                    this.showNotification('Failed to process documents: ' + error.message, 'error');
                }

                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Process Documents';
            }

            async readFiles(files) {
                const documents = [];
                
                for (const file of files) {
                    const text = await this.readFileAsText(file);
                    documents.push({
                        id: Date.now() + Math.random(),
                        filename: file.name,
                        text: text,
                        size: file.size,
                        type: file.type
                    });
                }
                
                return documents;
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }

            async loadRoomDocuments(roomId) {
                try {
                    const documents = await this.storage.getDocuments(roomId);
                    this.displayDocuments(documents);
                } catch (error) {
                    console.error('Failed to load room documents:', error);
                }
            }

            displayDocuments(documents) {
                const documentItems = document.getElementById('document-items');
                
                if (documents.length === 0) {
                    documentItems.innerHTML = '<div class="text-sm text-gray-500 italic">No documents processed</div>';
                    return;
                }

                documentItems.innerHTML = documents.map(doc => `
                    <div class="text-sm p-2 bg-gray-50 rounded flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-file text-blue-500 mr-2"></i>
                            <span class="text-gray-700">${doc.filename}</span>
                        </div>
                        <span class="text-gray-500">${(doc.size / 1024).toFixed(1)} KB</span>
                    </div>
                `).join('');
            }

            async loadRoomVectors(roomId) {
                try {
                    const vectorData = await this.storage.getVectors(roomId);
                    if (vectorData) {
                        this.vectorEngine.loadVectors(vectorData);
                    } else {
                        this.vectorEngine.clearVectors();
                    }
                } catch (error) {
                    console.error('Failed to load room vectors:', error);
                    this.vectorEngine.clearVectors();
                }
            }

            async loadRoomChatHistory(roomId) {
                try {
                    const history = await this.storage.getChatHistory(roomId);
                    this.clearChatMessages();
                    
                    history.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    history.forEach(msg => {
                        this.addMessageToChat(msg.sender, msg.message, msg.timestamp);
                    });
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                }
            }

            async sendMessage() {
                if (!this.currentRoom) {
                    this.showNotification('Please select a room first.', 'error');
                    return;
                }

                const questionInput = document.getElementById('question');
                const query = questionInput.value.trim();
                
                if (!query) return;

                if (this.vectorEngine.vectors.length === 0) {
                    this.showNotification('Please process some documents first.', 'error');
                    return;
                }

                questionInput.value = '';
                const sendBtn = document.getElementById('send-btn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                const userMessage = {
                    sender: 'user',
                    message: query,
                    timestamp: new Date().toISOString()
                };

                this.addMessageToChat(userMessage.sender, userMessage.message, userMessage.timestamp);
                await this.storage.saveChatHistory(this.currentRoom.id, userMessage);

                try {
                    const searchResults = await this.vectorEngine.search(query);
                    const context = searchResults.map(r => r.document.text).join('\n\n');
                    
                    let response;
                    if (this.openaiApiKey) {
                        response = await this.generateOpenAIResponse(query, context, this.currentRoom.model);
                    } else {
                        response = this.generateSimpleResponse(query, context, searchResults);
                    }

                    const assistantMessage = {
                        sender: 'assistant',
                        message: response,
                        timestamp: new Date().toISOString()
                    };

                    this.addMessageToChat(assistantMessage.sender, assistantMessage.message, assistantMessage.timestamp);
                    await this.storage.saveChatHistory(this.currentRoom.id, assistantMessage);

                    // Update room chat count
                    this.currentRoom.chat_count += 2;
                    await this.storage.saveRoom(this.currentRoom);
                    this.updateRoomList();
                } catch (error) {
                    const errorMessage = {
                        sender: 'error',
                        message: `Error: ${error.message}`,
                        timestamp: new Date().toISOString()
                    };
                    this.addMessageToChat(errorMessage.sender, errorMessage.message, errorMessage.timestamp);
                    await this.storage.saveChatHistory(this.currentRoom.id, errorMessage);
                }

                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }

            async generateOpenAIResponse(query, context, model) {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant that answers questions based on the provided context. Use the context to answer the user\'s question accurately and concisely.'
                            },
                            {
                                role: 'user',
                                content: `Context: ${context}\n\nQuestion: ${query}`
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            generateSimpleResponse(query, context, searchResults) {
                const topResult = searchResults[0];
                const similarity = (topResult.similarity * 100).toFixed(1);
                
                return `Based on the most relevant document (${similarity}% similarity):\n\n${context.substring(0, 500)}...\n\nNote: Set your OpenAI API key in settings for more intelligent responses.`;
            }

            addMessageToChat(sender, message, timestamp = null) {
                const messagesDiv = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message mb-4 ${sender === 'user' ? 'text-right' : 'text-left'}`;
                
                const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                const senderIcon = sender === 'user' ? 'fas fa-user' : sender === 'assistant' ? 'fas fa-robot' : 'fas fa-exclamation-triangle';
                const senderColor = sender === 'user' ? 'bg-blue-500' : sender === 'assistant' ? 'bg-green-500' : 'bg-red-500';

                messageDiv.innerHTML = `
                    <div class="inline-block max-w-xs lg:max-w-md xl:max-w-lg">
                        <div class="flex items-center ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-1">
                            <span class="text-xs text-gray-500 ${sender === 'user' ? 'mr-2' : 'ml-2'}">${time}</span>
                            <div class="${senderColor} text-white p-1 rounded-full w-6 h-6 flex items-center justify-center">
                                <i class="${senderIcon} text-xs"></i>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-md ${sender === 'user' ? 'bg-blue-50' : sender === 'assistant' ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="text-gray-800 whitespace-pre-wrap">${message}</p>
                        </div>
                    </div>
                `;

                // Remove the initial message if it exists
                const noChatMessage = document.getElementById('no-chat-message');
                if (noChatMessage && !noChatMessage.classList.contains('hidden')) {
                    noChatMessage.classList.add('hidden');
                }

                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            clearChatMessages() {
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                document.getElementById('no-chat-message').classList.remove('hidden');
            }

            async clearChatHistory() {
                if (!this.currentRoom) return;

                if (!confirm('Are you sure you want to clear all chat history for this room?')) {
                    return;
                }

                try {
                    await this.storage.clearChatHistory(this.currentRoom.id);
                    this.clearChatMessages();
                    
                    // Update room chat count
                    this.currentRoom.chat_count = 0;
                    await this.storage.saveRoom(this.currentRoom);
                    this.updateRoomList();
                    
                    this.showNotification('Chat history cleared successfully!', 'success');
                } catch (error) {
                    this.showNotification('Failed to clear chat history: ' + error.message, 'error');
                }
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            showProcessingIndicator(text) {
                const indicator = document.getElementById('processing-indicator');
                const textElement = document.getElementById('processing-text');
                textElement.textContent = text;
                indicator.style.display = 'block';
            }

            hideProcessingIndicator() {
                const indicator = document.getElementById('processing-indicator');
                indicator.style.display = 'none';
            }
        }

        // Initialize the application
        const app = new SmartDocumentWorkspace();
        
        // Make app globally available for onclick handlers
        window.app = app;
    </script>
</body>
</html>